#!/usr/bin/env bash
# fern-config-watch - Watch TOML config and regenerate JSON for live reload
#
# Usage:
#   fern-config-watch [toml-file]
#
# Default watches ~/.config/fern/config.toml
# Requires: dasel (or yq), inotifywait (inotify-tools)

set -euo pipefail

TOML_FILE="${1:-$HOME/.config/fern/config.toml}"
JSON_FILE="${TOML_FILE%.toml}.json"

if [[ ! -f "$TOML_FILE" ]]; then
    echo "Error: TOML file not found: $TOML_FILE"
    exit 1
fi

convert_config() {
    echo "Converting $TOML_FILE -> $JSON_FILE"
    if command -v dasel &>/dev/null; then
        dasel -f "$TOML_FILE" -w json > "$JSON_FILE"
    elif command -v yq &>/dev/null; then
        yq -o=json "$TOML_FILE" > "$JSON_FILE"
    elif command -v python3 &>/dev/null; then
        python3 -c "
import tomllib
import json
import sys
with open('$TOML_FILE', 'rb') as f:
    data = tomllib.load(f)
with open('$JSON_FILE', 'w') as f:
    json.dump(data, f, indent=2)
"
    else
        echo "Error: No TOML converter found. Install dasel, yq, or python3."
        exit 1
    fi
    echo "Done. QuickShell should reload automatically."
}

# Initial conversion
convert_config

# Watch for changes
echo "Watching $TOML_FILE for changes... (Ctrl+C to stop)"
if command -v inotifywait &>/dev/null; then
    while inotifywait -q -e modify,close_write "$TOML_FILE"; do
        sleep 0.1  # Debounce
        convert_config
    done
elif command -v fswatch &>/dev/null; then
    fswatch -o "$TOML_FILE" | while read -r; do
        convert_config
    done
else
    echo "Warning: No file watcher found. Install inotify-tools or fswatch."
    echo "Running one-time conversion only."
fi
